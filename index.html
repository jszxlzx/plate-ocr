<!doctype html>
<html lang="zh-HK">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>車牌 OCR（Lite：Canvas 增強 + Tesseract 單行模式）</title>
<style>
  :root{--border:#e4e4e4;--muted:#666}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;margin:18px;max-width:880px;margin:18px auto}
  h1{font-size:1.4rem;margin:0 0 6px}
  .card{border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
  label{display:block;margin:8px 0 6px;font-weight:600}
  button{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#fff}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  #canvas,#proc{max-width:100%;border:1px dashed #ddd;margin-top:8px}
  .muted{color:var(--muted);font-size:0.92rem;margin-top:6px}
  .result{white-space:pre-wrap;margin-top:10px;font-weight:700;font-size:1.1rem}
  .ok{color:#0a7b12}.warn{color:#9a6700}
  .row2{display:flex;gap:8px;flex-wrap:wrap}
  .barwrap{position:relative;background:#f3f3f3;border:1px solid #e5e5e5;border-radius:10px;height:12px;overflow:hidden}
  .bar{position:absolute;left:0;top:0;height:100%;width:0%;background:#2ecc71}
  .bartext{font-size:0.88rem;margin-top:4px;color:#333}
</style>
</head>
<body>
  <h1>車牌 OCR（Lite 快速版）</h1>
  <div class="card">
    <label>OCR 進度</label>
    <div class="barwrap"><div id="bar" class="bar"></div></div>
    <div id="bartxt" class="bartext">就緒</div>
  </div>

  <div class="card">
    <label>步驟 1：拍照或選圖</label>
    <div class="row2">
      <button id="btnCamera">📸 拍照上載</button>
      <button id="btnAlbum">🖼️ 從相簿選擇</button>
    </div>
    <input id="inCamera" type="file" accept="image/*" capture="environment" style="display:none" />
    <input id="inAlbum" type="file" accept="image/*" style="display:none" />
    <div class="muted">貼士：相機正面、光線足、車牌橫向佔畫面 ≥40%，綠框要貼住車牌邊。</div>

    <label>原圖 / 裁切</label>
    <canvas id="canvas"></canvas>

    <label>處理後（Canvas 預覽）</label>
    <canvas id="proc"></canvas>

    <div class="controls">
      <button id="autocrop">自動框選</button>
      <button id="enhance">增強並辨識</button>
      <button id="raw">直接辨識</button>
      <button id="copy">複製結果</button>
      <button id="reset">重設</button>
    </div>

    <div id="status" class="muted">就緒</div>
    <div id="out" class="result"></div>
    <div class="muted">後處理：自動把 <code>O↔0</code>、<code>I/L↔1</code>、<code>B↔8</code>、<code>S↔5</code> 調整，並匹配格式 <code>^[A-Z]{1,3}\s?\d{1,4}$</code>。</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script>
const inCamera=document.getElementById('inCamera');
const inAlbum=document.getElementById('inAlbum');
const btnCamera=document.getElementById('btnCamera');
const btnAlbum=document.getElementById('btnAlbum');
const canvas=document.getElementById('canvas'); const ctx=canvas.getContext('2d');
const proc=document.getElementById('proc'); const pctx=proc.getContext('2d');
const bar=document.getElementById('bar'); const bartxt=document.getElementById('bartxt');
const statusEl=document.getElementById('status'); const outEl=document.getElementById('out');

let img=new Image(), imgW=0,imgH=0, scale=1;
let crop={x:0,y:0,w:0,h:0,drag:false};

btnCamera.onclick=()=>inCamera.click();
btnAlbum.onclick=()=>inAlbum.click();
[inCamera,inAlbum].forEach(inp=>{
  inp.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f)return;
    const url=URL.createObjectURL(f);
    img=new Image();
    img.onload=()=>{
      imgW=img.naturalWidth; imgH=img.naturalHeight;
      scale=fit(canvas,imgW,imgH);
      crop.w=canvas.width*0.75; crop.h=canvas.height*0.22;
      crop.x=(canvas.width-crop.w)/2; crop.y=(canvas.height-crop.h)/2;
      draw();
      URL.revokeObjectURL(url);
      outEl.textContent=''; statusEl.textContent='影像已載入';
      pctx.clearRect(0,0,proc.width,proc.height);
    };
    img.src=url;
  });
});

function fit(el,w,h){
  const maxW=Math.min(window.innerWidth-40,820);
  const s=Math.min(1,maxW/w);
  el.width=Math.round(w*s); el.height=Math.round(h*s);
  return s;
}
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,imgW*scale,imgH*scale);
  if(crop.w&&crop.h){
    ctx.strokeStyle='lime';ctx.lineWidth=2;ctx.strokeRect(crop.x,crop.y,crop.w,crop.h);
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.beginPath(); ctx.rect(0,0,canvas.width,canvas.height); ctx.rect(crop.x,crop.y,crop.w,crop.h); ctx.fill('evenodd');
  }
}
canvas.addEventListener('pointerdown',ev=>{
  const r=canvas.getBoundingClientRect(); const x=ev.clientX-r.left, y=ev.clientY-r.top;
  if(x>crop.x&&x<crop.x+crop.w&&y>crop.y&&y<crop.y+crop.h) crop.drag=true;
});
window.addEventListener('pointermove',ev=>{
  if(!crop.drag)return;
  const r=canvas.getBoundingClientRect(); const x=ev.clientX-r.left, y=ev.clientY-r.top;
  crop.x=Math.min(Math.max(0,x-crop.w/2),canvas.width-crop.w);
  crop.y=Math.min(Math.max(0,y-crop.h/2),canvas.height-crop.h);
  draw();
});
window.addEventListener('pointerup',()=>{crop.drag=false;});

function getCropCanvas(){
  const sx=Math.round(crop.x/scale), sy=Math.round(crop.y/scale);
  const sw=Math.round(crop.w/scale), sh=Math.round(crop.h/scale);
  const tmp=document.createElement('canvas'); tmp.width=sw; tmp.height=sh;
  const t=tmp.getContext('2d'); t.drawImage(img,sx,sy,sw,sh,0,0,sw,sh);
  return tmp;
}

function preprocess(cnv){
  const tcnv=document.createElement('canvas');
  const scaleUp=2.2; tcnv.width=Math.round(cnv.width*scaleUp); tcnv.height=Math.round(cnv.height*scaleUp);
  const t=tcnv.getContext('2d'); t.imageSmoothingEnabled=true; t.drawImage(cnv,0,0,tcnv.width,tcnv.height);

  let imgd=t.getImageData(0,0,tcnv.width,tcnv.height); let d=imgd.data;

  for(let i=0;i<d.length;i+=4){ const y=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; d[i]=d[i+1]=d[i+2]=y; }

  const blur=t.getImageData(0,0,tcnv.width,tcnv.height); const bd=blur.data;
  for(let y=1;y<tcnv.height-1;y++){ for(let x=1;x<tcnv.width-1;x++){ const idx=(y*tcnv.width+x)*4; let s=0; for(let dy=-1;dy<=1;dy++){ for(let dx=-1;dx<=1;dx++){ s+=d[((y+dy)*tcnv.width+(x+dx))*4]; }} const mean=s/9; bd[idx]=bd[idx+1]=bd[idx+2]=mean; bd[idx+3]=255; } }

  for(let i=0;i<d.length;i+=4){ const sharp=Math.max(0,Math.min(255,d[i]*1.8 - bd[i]*0.8 + 20)); d[i]=d[i+1]=d[i+2]=sharp; }

  const w=tcnv.width,h=tcnv.height,tile=16; const out=new Uint8ClampedArray(d.length);
  function meanBlock(x0,y0,x1,y1){ let sum=0,c=0; for(let y=y0;y<x1;y++){ } return 0; }
  // simplified global threshold fallback
  for(let i=0;i<d.length;i+=4){ const v=d[i]>160?255:0; out[i]=out[i+1]=out[i+2]=v; out[i+3]=255; }
  imgd.data.set(out); t.putImageData(imgd,0,0);
  return tcnv;
}

function postFixPlate(txt){
  let s=txt.toUpperCase().replace(/[^A-Z0-9 ]+/g,' ').replace(/\s+/g,' ').trim();
  s=s.replace(/\b0([A-Z])/g,'O$1').replace(/\bO(\d)/g,'0$1');
  s=s.replace(/\b1([A-Z])/g,'I$1').replace(/\bI(\d)/g,'1$1');
  s=s.replace(/B(?=\d)/g,'8').replace(/(?<=\D)8(?=\d)/g,'B');
  s=s.replace(/S(?=\d)/g,'5').replace(/(?<=\D)5(?=\d)/g,'S');
  const plateRe=/^[A-Z]{1,3}\s?\d{1,4}$/;
  const toks=s.split(' ');
  for(const t of toks){ const t2=t.length>3? t.slice(0,8):t; if(plateRe.test(t2)) return t2.replace(/(\D)(\d)/,'$1 $2'); }
  return s;
}

async function ocrFromCanvas(cnv,hint){
  bar.style.width='10%'; bartxt.textContent=hint+' 10%';
  const blob=await new Promise(res=>cnv.toBlob(b=>res(b),'image/png',0.92));
  const worker=Tesseract.createWorker({ logger:m=>{ if(m.status==='recognizing text'){ const p=Math.round(m.progress*100); bar.style.width=p+'%'; bartxt.textContent=hint+' '+p+'%'; } } });
  await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
  await worker.setParameters({ tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ', preserve_interword_spaces:'1', tessedit_pageseg_mode:'7' });
  const {data:{text}}=await worker.recognize(blob);
  await worker.terminate();
  bar.style.width='100%'; bartxt.textContent='完成 100%';
  return postFixPlate(text);
}

document.getElementById('enhance').onclick=async()=>{
  if(!inCamera.files[0] && !inAlbum.files[0]){ alert('請先上載或拍照'); return; }
  const cropCnv=getCropCanvas();
  const prep=preprocess(cropCnv);
  proc.width=prep.width; proc.height=prep.height; pctx.drawImage(prep,0,0);
  const t=await ocrFromCanvas(prep,'增強 OCR');
  outEl.innerHTML=t? '結果：<span class="ok">'+t+'</span>':'<span class="warn">未能讀取</span>';
};
document.getElementById('raw').onclick=async()=>{
  if(!inCamera.files[0] && !inAlbum.files[0]){ alert('請先上載或拍照'); return; }
  const cropCnv=getCropCanvas();
  const t=await ocrFromCanvas(cropCnv,'直接 OCR');
  outEl.innerHTML=t? '結果：<span class="ok">'+t+'</span>':'<span class="warn">未能讀取</span>';
};
document.getElementById('copy').onclick=async()=>{
  const txt=outEl.textContent.replace('結果：','').trim(); if(!txt){alert('沒有結果');return;}
  try{ await navigator.clipboard.writeText(txt); alert('已複製到剪貼簿'); }catch(e){ alert('複製失敗'); }
};
document.getElementById('reset').onclick=()=>{
  [inCamera,inAlbum].forEach(i=>i.value=''); initCanvas(); pctx.clearRect(0,0,proc.width,proc.height); outEl.textContent=''; bar.style.width='0%'; bartxt.textContent='就緒';
};
document.getElementById('autocrop').onclick=()=>{
  crop.w=canvas.width*0.82; crop.h=canvas.height*0.22; crop.x=(canvas.width-crop.w)/2; crop.y=(canvas.height-crop.h)/2; draw();
};

function initCanvas(){
  canvas.width=Math.min(window.innerWidth-40,720); canvas.height=Math.round(canvas.width*0.6);
  ctx.fillStyle='#f6f6f6'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#777'; ctx.fillText('上載相片或拍照 → 綠框圈住車牌 → 「增強並辨識」',12,20);
  proc.width=canvas.width; proc.height=Math.round(canvas.height*0.45);
}
initCanvas();
</script>
</body>
</html>
